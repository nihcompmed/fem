<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>Multiple sequence alignment &mdash; fem  documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../../../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../../../_static/scipy.css" type="text/css" >
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/js/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" >
    <link rel="search" title="Search" href="../../../search.html" >
    <link rel="top" title="fem  documentation" href="../../../index.html" > 
  </head>
  <body>

  <div class="container">
    <div class="header">
    </div>
  </div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
        <li class="active"><a href="https://www.niddk.nih.gov/research-funding/at-niddk/labs-branches/LBM">LBM</a></li>
        <li class="active"><a href="https://pypi.python.org/pypi/fem">fem</a></li>
	
        <li class="active"><a href="../../../index.html">fem  documentation</a></li>
	 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../../../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../../../f-modindex.html" title="Fortran Module Index"
           >fortran modules</a>
      </li>
      <li class="active">
        <a href="../../../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 9ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<div class="section" id="Multiple-sequence-alignment">
<h1>Multiple sequence alignment<a class="headerlink" href="#Multiple-sequence-alignment" title="Permalink to this headline">Â¶</a></h1>
<p>Import modules, including a function
<code class="docutils literal notranslate"><span class="pre">`parse_pfam</span></code> &lt;../../../data/msa/parse_pfam.py&gt;`__ in the <code class="docutils literal notranslate"><span class="pre">data_dir</span></code>
that downloads the current release of the <a class="reference external" href="https://pfam.xfam.org/">Pfam
database</a>, and stores the MSAs in that
database on the local disk. Get a list of IDs from the <a class="reference external" href="https://www.rcsb.org/">Protein Data
Bank</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>import fem
%matplotlib inline
import matplotlib.pyplot as plt
from matplotlib import patches, colors
import numpy as np
import pandas as pd
from scipy.spatial import distance_matrix
import sys, os, time, pickle, pymol, Bio.PDB, warnings, nglview
from Bio import BiopythonWarning
warnings.simplefilter(&#39;ignore&#39;, BiopythonWarning)
data_dir = &#39;../../../data/msa&#39;
sys.path.append(data_dir)
from parse_pfam import parse_pfam
</pre></div>
</div>
</div>
<p>Get a table <code class="docutils literal notranslate"><span class="pre">pfam</span></code> of information for all protein families in the Pfam
database and a table <code class="docutils literal notranslate"><span class="pre">pdb_refs</span></code> of all references from sequences to
PDB structures.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>pfam, pdb_refs = parse_pfam(data_dir)
print &#39;total MSAs: %i, total PDB refs: %i&#39; % (pfam.shape[0], pdb_refs.shape[0])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
total MSAs: 16479, total PDB refs: 207746
</pre></div></div>
</div>
<p>Subset the Pfam table <code class="docutils literal notranslate"><span class="pre">pfam</span></code> to contain only the families that contain
at least one sequence with a reference to a PDB structure.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>pfam = pfam[pfam.index.isin(pdb_refs.index)]
print &#39;MSAs with PDB refs: %i&#39; % (pfam.shape[0],)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
MSAs with PDB refs: 5327
</pre></div></div>
</div>
<p>Each row in <code class="docutils literal notranslate"><span class="pre">pfam</span></code> contains information about a single protein
family/multiple sequence alignment. Up until this point, the columns of
<code class="docutils literal notranslate"><span class="pre">pfam</span></code> are <code class="docutils literal notranslate"><span class="pre">res</span></code>: the number of residues in each sequence of the
alignment, <code class="docutils literal notranslate"><span class="pre">seq</span></code>: the number of sequences in the alignment. Now letâs
add a column <code class="docutils literal notranslate"><span class="pre">size=res*seq</span></code> and sort by that column to see which
families contains the most data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>pfam[&#39;size&#39;] = pfam[&#39;res&#39;]* pfam[&#39;seq&#39;]
pfam.sort_values(by=&#39;size&#39;, ascending=False, inplace=True)
pfam.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>res</th>
      <th>seq</th>
      <th>pdb_refs</th>
      <th>size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>PF00005</th>
      <td>2386</td>
      <td>369723</td>
      <td>407</td>
      <td>882159078</td>
    </tr>
    <tr>
      <th>PF00069</th>
      <td>3194</td>
      <td>236455</td>
      <td>3910</td>
      <td>755237270</td>
    </tr>
    <tr>
      <th>PF07690</th>
      <td>3427</td>
      <td>214283</td>
      <td>23</td>
      <td>734347841</td>
    </tr>
    <tr>
      <th>PF00067</th>
      <td>4853</td>
      <td>85020</td>
      <td>768</td>
      <td>412602060</td>
    </tr>
    <tr>
      <th>PF00501</th>
      <td>3767</td>
      <td>87704</td>
      <td>145</td>
      <td>330380968</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Each row in the PDB references table <code class="docutils literal notranslate"><span class="pre">pdb_refs</span></code> contains information
about a cross-reference between a protein family in the Pfam database
and a protein structure in the PDB database. Up until this point, the
columns of the table are <code class="docutils literal notranslate"><span class="pre">seq</span></code>: the index of a sequence in the protein
family, <code class="docutils literal notranslate"><span class="pre">uniprot_id</span></code>: the ID of the sequence in the
<a class="reference external" href="https://www.uniprot.org/help/uniprotkb">UniProtKB</a> database,
<code class="docutils literal notranslate"><span class="pre">uniprot_start</span></code>/<code class="docutils literal notranslate"><span class="pre">uniprot_end</span></code>: the start and end residue positions
of the UniProtKB sequence that appears in the MSA, <code class="docutils literal notranslate"><span class="pre">pdb_id</span></code>: the PDB
ID, <code class="docutils literal notranslate"><span class="pre">chain</span></code>: the PDB protein structure chain,
<code class="docutils literal notranslate"><span class="pre">pdb_start</span></code>/<code class="docutils literal notranslate"><span class="pre">pdb_end</span></code>: the start and end residue positions of the
PDB sequence that appears in the MSA. Letâs create a column <code class="docutils literal notranslate"><span class="pre">res</span></code> that
contains the length of the sequence and sort by that column.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>pdb_refs[&#39;res&#39;] = pdb_refs[&#39;pdb_end&#39;] - pdb_refs[&#39;pdb_start&#39;] + 1
pdb_refs.sort_values(by=&#39;res&#39;, ascending=False, inplace=True)
pdb_refs.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>seq</th>
      <th>uniprot_id</th>
      <th>uniprot_start</th>
      <th>uniprot_end</th>
      <th>pdb_id</th>
      <th>chain</th>
      <th>pdb_start</th>
      <th>pdb_end</th>
      <th>res</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>PF11894</th>
      <td>578</td>
      <td>NU205_HUMAN</td>
      <td>14</td>
      <td>1684</td>
      <td>5IJN</td>
      <td>J</td>
      <td>14</td>
      <td>1684</td>
      <td>1671</td>
    </tr>
    <tr>
      <th>PF11894</th>
      <td>578</td>
      <td>NU205_HUMAN</td>
      <td>14</td>
      <td>1684</td>
      <td>5IJN</td>
      <td>P</td>
      <td>14</td>
      <td>1684</td>
      <td>1671</td>
    </tr>
    <tr>
      <th>PF11894</th>
      <td>578</td>
      <td>NU205_HUMAN</td>
      <td>14</td>
      <td>1684</td>
      <td>5IJN</td>
      <td>D</td>
      <td>14</td>
      <td>1684</td>
      <td>1671</td>
    </tr>
    <tr>
      <th>PF11894</th>
      <td>578</td>
      <td>NU205_HUMAN</td>
      <td>14</td>
      <td>1684</td>
      <td>5IJN</td>
      <td>V</td>
      <td>14</td>
      <td>1684</td>
      <td>1671</td>
    </tr>
    <tr>
      <th>PF02463</th>
      <td>2434</td>
      <td>SMC1_YEAST</td>
      <td>3</td>
      <td>1213</td>
      <td>1W1W</td>
      <td>C</td>
      <td>3</td>
      <td>1213</td>
      <td>1211</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Weâll examine the particular protein family with Pfam accesion code
PF16592. This protein family corresponds to the REC lobe of
CRISPR-associated endonuclease Cas9. The REC lobe and the NUC lobe of
Cas9 fold to present a positively charged groove at their interface
which accommodates the negatively charged sgRNA: target DNA
heteroduplex. <a class="reference external" href="https://www.ncbi.nlm.nih.gov/pubmed/24529477">[1]</a></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># Cas 9 family
ac = &#39;PF16592&#39;
size_rank = pfam[&#39;size&#39;].rank(ascending=False)[ac].astype(int)
print &#39;size rank: %i of %i&#39; % (size_rank, pfam.shape[0])
pfam[pfam.index == ac]
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
size rank: 3734 of 5327
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>res</th>
      <th>seq</th>
      <th>pdb_refs</th>
      <th>size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>PF16592</th>
      <td>1079</td>
      <td>146</td>
      <td>21</td>
      <td>157534</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>The MSA data for Pfam family with accession code PFXXXXX is stored on
the local disk in the <code class="docutils literal notranslate"><span class="pre">Pfam-A.full/PFXXXXX</span></code> subdirectory of
<code class="docutils literal notranslate"><span class="pre">data_dir</span></code> defined above. Here, we define a function for loading MSA
data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>def get_msa(ac):
    fam_dir = os.path.join(data_dir, &#39;Pfam-A.full&#39;, ac)
    msa = np.load(os.path.join(fam_dir, &#39;msa.npy&#39;))
    return msa
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>msa = get_msa(ac)
msa_int = fem.discrete.fit.categorize(msa)[0]
aa = np.array([np.unique(s) for s in msa])
one_aa = np.array([len(a) == 1 for a in aa])
two_aa = np.array([len(a) == 2 for a in aa])
missing_aa_res = np.array([&#39;-&#39; in a for a in aa])
conserved_residues = one_aa | (two_aa &amp; missing_aa_res)
m = np.array([len(a) for a in aa])
m = m[~conserved_residues]
mm = np.insert(m.cumsum(), 0, 0)
print &#39;conserved residues: %i of %i&#39; % (conserved_residues.sum(), msa.shape[0])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
conserved residues: 225 of 1079
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>msa_code = np.zeros(msa.shape, dtype=int)
msa_code[conserved_residues] = 2
for j, s in enumerate(msa.T):
    msa_code[s == &#39;-&#39;, j] += 1

fig, ax = plt.subplots(1, 1, figsize=(16, 6))
ax.set_xlabel(&#39;sequence&#39;)
ax.set_ylabel(&#39;residue&#39;)
cmap = plt.cm.get_cmap(&#39;plasma&#39;, 4)
ax.imshow(msa_code, aspect=&#39;auto&#39;, cmap=cmap)
labels = [&#39;active&#39;, &#39;alignment gap&#39;, &#39;conserved residue&#39;, &#39;alignment gap and conserved residue&#39;]
handles = [patches.Patch(color=cmap(i), label=labels[i]) for i in range(4)]
plt.legend(handles=handles, ncol=4)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_16_0.png" src="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_16_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>start = time.time()
w, d = fem.discrete.fit.fit(msa[~conserved_residues], degs=[1], iters=10)
# for i1, i2 in zip(mm[:-1], mm[1:]):
#     w[1][:, i1:i2] -= w[1][:, i1:i2].mean(1)[:,np.newaxis]
end = time.time()
print &#39;model fit time: %02f seconds&#39; % (end-start,)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
model fit time: 5.891613 seconds
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>fig, ax = plt.subplots(1, 2, figsize=(12, 6))
scale = 1e-1 * np.abs(w[1]).max()
ax[0].matshow(w[1], cmap=plt.cm.seismic, vmin=-scale, vmax=scale)
ax[0].axis(&#39;off&#39;)
ax[0].set_title(&#39;Pfam: %s&#39; % (ac,))
for di in d:
    ax[1].plot(di, &#39;k-&#39;, lw=0.1)
ax[1].set_xlabel(&#39;iteration&#39;)
ax[1].set_ylabel(&#39;discrepancy&#39;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_18_0.png" src="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_18_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [44]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># di = np.zeros(())
# for i1, i2 in zip(mm[:-1], mm[1:]):
#     for j1, j2 in zip(mm[:-1], mm[1:]):
#         print np.exp(w[1][i1:i2, j1:j2])
msa.shape, mm.shape
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[44]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>((1079, 146), (855,))
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>refs = pdb_refs[pdb_refs.index.str.contains(ac)]
refs.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>seq</th>
      <th>uniprot_id</th>
      <th>uniprot_start</th>
      <th>uniprot_end</th>
      <th>pdb_id</th>
      <th>chain</th>
      <th>pdb_start</th>
      <th>pdb_end</th>
      <th>res</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>PF16592</th>
      <td>70</td>
      <td>CAS9_STRP1</td>
      <td>181</td>
      <td>712</td>
      <td>4OO8</td>
      <td>A</td>
      <td>181</td>
      <td>712</td>
      <td>532</td>
    </tr>
    <tr>
      <th>PF16592</th>
      <td>70</td>
      <td>CAS9_STRP1</td>
      <td>181</td>
      <td>712</td>
      <td>4CMQ</td>
      <td>A</td>
      <td>181</td>
      <td>712</td>
      <td>532</td>
    </tr>
    <tr>
      <th>PF16592</th>
      <td>70</td>
      <td>CAS9_STRP1</td>
      <td>181</td>
      <td>712</td>
      <td>4OO8</td>
      <td>D</td>
      <td>181</td>
      <td>712</td>
      <td>532</td>
    </tr>
    <tr>
      <th>PF16592</th>
      <td>70</td>
      <td>CAS9_STRP1</td>
      <td>181</td>
      <td>712</td>
      <td>4ZT0</td>
      <td>A</td>
      <td>181</td>
      <td>712</td>
      <td>532</td>
    </tr>
    <tr>
      <th>PF16592</th>
      <td>70</td>
      <td>CAS9_STRP1</td>
      <td>181</td>
      <td>712</td>
      <td>5F9R</td>
      <td>B</td>
      <td>181</td>
      <td>712</td>
      <td>532</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>ref = refs.iloc[0]
seq = msa[:, ref.seq]
missing_aa_seq = seq == &#39;-&#39;
print &#39;PDB length == MSA seq length? %s&#39; % (ref.res == seq[~missing_aa_seq].shape[0])
print &#39;aa sequence: %s&#39; % (seq[~missing_aa_seq])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PDB length == MSA seq length? True
aa sequence: [&#39;v&#39; &#39;d&#39; &#39;k&#39; &#39;l&#39; &#39;f&#39; &#39;i&#39; &#39;q&#39; &#39;l&#39; &#39;v&#39; &#39;q&#39; &#39;t&#39; &#39;y&#39; &#39;n&#39; &#39;q&#39; &#39;l&#39; &#39;f&#39; &#39;e&#39; &#39;e&#39;
 &#39;n&#39; &#39;p&#39; &#39;i&#39; &#39;n&#39; &#39;a&#39; &#39;s&#39; &#39;g&#39; &#39;v&#39; &#39;d&#39; &#39;a&#39; &#39;k&#39; &#39;a&#39; &#39;i&#39; &#39;l&#39; &#39;s&#39; &#39;a&#39; &#39;r&#39; &#39;l&#39;
 &#39;s&#39; &#39;k&#39; &#39;s&#39; &#39;r&#39; &#39;r&#39; &#39;l&#39; &#39;e&#39; &#39;n&#39; &#39;l&#39; &#39;i&#39; &#39;a&#39; &#39;q&#39; &#39;l&#39; &#39;p&#39; &#39;g&#39; &#39;e&#39; &#39;k&#39; &#39;k&#39;
 &#39;n&#39; &#39;g&#39; &#39;l&#39; &#39;f&#39; &#39;g&#39; &#39;n&#39; &#39;l&#39; &#39;i&#39; &#39;a&#39; &#39;l&#39; &#39;s&#39; &#39;l&#39; &#39;g&#39; &#39;l&#39; &#39;t&#39; &#39;p&#39; &#39;n&#39; &#39;f&#39;
 &#39;k&#39; &#39;s&#39; &#39;n&#39; &#39;f&#39; &#39;d&#39; &#39;l&#39; &#39;a&#39; &#39;e&#39; &#39;d&#39; &#39;a&#39; &#39;k&#39; &#39;l&#39; &#39;q&#39; &#39;l&#39; &#39;s&#39; &#39;k&#39; &#39;d&#39; &#39;t&#39;
 &#39;y&#39; &#39;d&#39; &#39;d&#39; &#39;d&#39; &#39;l&#39; &#39;d&#39; &#39;n&#39; &#39;l&#39; &#39;l&#39; &#39;a&#39; &#39;q&#39; &#39;i&#39; &#39;g&#39; &#39;d&#39; &#39;q&#39; &#39;y&#39; &#39;a&#39; &#39;d&#39;
 &#39;l&#39; &#39;f&#39; &#39;l&#39; &#39;a&#39; &#39;a&#39; &#39;k&#39; &#39;n&#39; &#39;l&#39; &#39;s&#39; &#39;d&#39; &#39;a&#39; &#39;i&#39; &#39;l&#39; &#39;l&#39; &#39;s&#39; &#39;d&#39; &#39;i&#39; &#39;l&#39;
 &#39;r&#39; &#39;v&#39; &#39;n&#39; &#39;t&#39; &#39;e&#39; &#39;i&#39; &#39;t&#39; &#39;k&#39; &#39;a&#39; &#39;p&#39; &#39;l&#39; &#39;s&#39; &#39;a&#39; &#39;s&#39; &#39;m&#39; &#39;i&#39; &#39;k&#39; &#39;r&#39;
 &#39;y&#39; &#39;d&#39; &#39;e&#39; &#39;h&#39; &#39;h&#39; &#39;q&#39; &#39;d&#39; &#39;l&#39; &#39;t&#39; &#39;l&#39; &#39;l&#39; &#39;k&#39; &#39;a&#39; &#39;l&#39; &#39;v&#39; &#39;r&#39; &#39;q&#39; &#39;q&#39;
 &#39;l&#39; &#39;p&#39; &#39;e&#39; &#39;k&#39; &#39;y&#39; &#39;k&#39; &#39;e&#39; &#39;i&#39; &#39;f&#39; &#39;f&#39; &#39;d&#39; &#39;q&#39; &#39;s&#39; &#39;k&#39; &#39;n&#39; &#39;g&#39; &#39;y&#39; &#39;a&#39;
 &#39;g&#39; &#39;y&#39; &#39;i&#39; &#39;d&#39; &#39;g&#39; &#39;g&#39; &#39;a&#39; &#39;s&#39; &#39;q&#39; &#39;e&#39; &#39;e&#39; &#39;f&#39; &#39;y&#39; &#39;k&#39; &#39;f&#39; &#39;i&#39; &#39;k&#39; &#39;p&#39;
 &#39;i&#39; &#39;l&#39; &#39;e&#39; &#39;k&#39; &#39;m&#39; &#39;d&#39; &#39;g&#39; &#39;t&#39; &#39;e&#39; &#39;e&#39; &#39;l&#39; &#39;l&#39; &#39;v&#39; &#39;k&#39; &#39;l&#39; &#39;n&#39; &#39;r&#39; &#39;e&#39;
 &#39;d&#39; &#39;l&#39; &#39;l&#39; &#39;r&#39; &#39;k&#39; &#39;q&#39; &#39;r&#39; &#39;t&#39; &#39;f&#39; &#39;d&#39; &#39;n&#39; &#39;g&#39; &#39;s&#39; &#39;i&#39; &#39;p&#39; &#39;h&#39; &#39;q&#39; &#39;i&#39;
 &#39;h&#39; &#39;l&#39; &#39;g&#39; &#39;e&#39; &#39;l&#39; &#39;h&#39; &#39;a&#39; &#39;i&#39; &#39;l&#39; &#39;r&#39; &#39;r&#39; &#39;q&#39; &#39;e&#39; &#39;d&#39; &#39;f&#39; &#39;y&#39; &#39;p&#39; &#39;f&#39;
 &#39;l&#39; &#39;k&#39; &#39;d&#39; &#39;n&#39; &#39;r&#39; &#39;e&#39; &#39;k&#39; &#39;i&#39; &#39;e&#39; &#39;k&#39; &#39;i&#39; &#39;l&#39; &#39;t&#39; &#39;f&#39; &#39;r&#39; &#39;i&#39; &#39;p&#39; &#39;y&#39;
 &#39;y&#39; &#39;v&#39; &#39;g&#39; &#39;p&#39; &#39;l&#39; &#39;a&#39; &#39;r&#39; &#39;g&#39; &#39;n&#39; &#39;s&#39; &#39;r&#39; &#39;f&#39; &#39;a&#39; &#39;w&#39; &#39;m&#39; &#39;t&#39; &#39;r&#39; &#39;k&#39;
 &#39;s&#39; &#39;e&#39; &#39;e&#39; &#39;t&#39; &#39;i&#39; &#39;t&#39; &#39;p&#39; &#39;w&#39; &#39;n&#39; &#39;f&#39; &#39;e&#39; &#39;e&#39; &#39;v&#39; &#39;v&#39; &#39;d&#39; &#39;k&#39; &#39;g&#39; &#39;a&#39;
 &#39;s&#39; &#39;a&#39; &#39;q&#39; &#39;s&#39; &#39;f&#39; &#39;i&#39; &#39;e&#39; &#39;r&#39; &#39;m&#39; &#39;t&#39; &#39;n&#39; &#39;f&#39; &#39;d&#39; &#39;k&#39; &#39;n&#39; &#39;l&#39; &#39;p&#39; &#39;n&#39;
 &#39;e&#39; &#39;k&#39; &#39;v&#39; &#39;l&#39; &#39;p&#39; &#39;k&#39; &#39;h&#39; &#39;s&#39; &#39;l&#39; &#39;l&#39; &#39;y&#39; &#39;e&#39; &#39;y&#39; &#39;f&#39; &#39;t&#39; &#39;v&#39; &#39;y&#39; &#39;n&#39;
 &#39;e&#39; &#39;l&#39; &#39;t&#39; &#39;k&#39; &#39;v&#39; &#39;k&#39; &#39;y&#39; &#39;v&#39; &#39;t&#39; &#39;e&#39; &#39;g&#39; &#39;m&#39; &#39;r&#39; &#39;k&#39; &#39;p&#39; &#39;a&#39; &#39;f&#39; &#39;l&#39;
 &#39;s&#39; &#39;g&#39; &#39;e&#39; &#39;q&#39; &#39;k&#39; &#39;k&#39; &#39;a&#39; &#39;i&#39; &#39;v&#39; &#39;d&#39; &#39;l&#39; &#39;l&#39; &#39;f&#39; &#39;k&#39; &#39;t&#39; &#39;n&#39; &#39;r&#39; &#39;k&#39;
 &#39;v&#39; &#39;t&#39; &#39;v&#39; &#39;k&#39; &#39;q&#39; &#39;l&#39; &#39;k&#39; &#39;e&#39; &#39;d&#39; &#39;y&#39; &#39;f&#39; &#39;k&#39; &#39;k&#39; &#39;i&#39; &#39;e&#39; &#39;c&#39; &#39;f&#39; &#39;d&#39;
 &#39;s&#39; &#39;v&#39; &#39;e&#39; &#39;i&#39; &#39;s&#39; &#39;g&#39; &#39;v&#39; &#39;e&#39; &#39;d&#39; &#39;r&#39; &#39;f&#39; &#39;n&#39; &#39;a&#39; &#39;s&#39; &#39;l&#39; &#39;g&#39; &#39;t&#39; &#39;y&#39;
 &#39;h&#39; &#39;d&#39; &#39;l&#39; &#39;l&#39; &#39;k&#39; &#39;i&#39; &#39;i&#39; &#39;k&#39; &#39;d&#39; &#39;k&#39; &#39;d&#39; &#39;f&#39; &#39;l&#39; &#39;d&#39; &#39;n&#39; &#39;e&#39; &#39;e&#39; &#39;n&#39;
 &#39;e&#39; &#39;d&#39; &#39;i&#39; &#39;l&#39; &#39;e&#39; &#39;d&#39; &#39;i&#39; &#39;v&#39; &#39;l&#39; &#39;t&#39; &#39;l&#39; &#39;t&#39; &#39;l&#39; &#39;f&#39; &#39;e&#39; &#39;d&#39; &#39;r&#39; &#39;e&#39;
 &#39;m&#39; &#39;i&#39; &#39;e&#39; &#39;e&#39; &#39;r&#39; &#39;l&#39; &#39;k&#39; &#39;t&#39; &#39;y&#39; &#39;a&#39; &#39;h&#39; &#39;l&#39; &#39;f&#39; &#39;d&#39; &#39;d&#39; &#39;k&#39; &#39;v&#39; &#39;m&#39;
 &#39;k&#39; &#39;q&#39; &#39;l&#39; &#39;k&#39; &#39;r&#39; &#39;r&#39; &#39;r&#39; &#39;y&#39; &#39;t&#39; &#39;g&#39; &#39;w&#39; &#39;g&#39; &#39;r&#39; &#39;l&#39; &#39;s&#39; &#39;r&#39; &#39;k&#39; &#39;l&#39;
 &#39;i&#39; &#39;n&#39; &#39;g&#39; &#39;i&#39; &#39;r&#39; &#39;d&#39; &#39;k&#39; &#39;q&#39; &#39;s&#39; &#39;g&#39; &#39;k&#39; &#39;t&#39; &#39;i&#39; &#39;l&#39; &#39;d&#39; &#39;f&#39; &#39;l&#39; &#39;k&#39;
 &#39;s&#39; &#39;d&#39; &#39;g&#39; &#39;f&#39; &#39;a&#39; &#39;n&#39; &#39;r&#39; &#39;n&#39; &#39;f&#39; &#39;m&#39; &#39;q&#39; &#39;l&#39; &#39;i&#39; &#39;h&#39; &#39;d&#39; &#39;d&#39; &#39;s&#39; &#39;l&#39;
 &#39;t&#39; &#39;f&#39; &#39;k&#39; &#39;e&#39; &#39;d&#39; &#39;i&#39; &#39;q&#39; &#39;k&#39; &#39;a&#39; &#39;q&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>seq_int = msa_int[:, ref.seq]
seq_int = seq_int[~conserved_residues]
w_idx = mm[:-1] + seq_int
w_idx = w_idx[~missing_aa_seq[~conserved_residues]]
w_seq = w[1][np.ix_(w_idx, w_idx)]

fig, ax = plt.subplots(1, 1, figsize=(6, 6))
scale = 1e-1 * np.abs(w_seq).max()
ax.matshow(w_seq, cmap=plt.cm.seismic, vmin=-scale, vmax=scale)
ax.axis(&#39;off&#39;)
ax.set_title(&#39;PDB: %s, chain %s, residues %i-%i&#39; % (ref.pdb_id, ref.chain, ref.pdb_start, ref.pdb_end))
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_22_0.png" src="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_22_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>def get_contact_map(ref, dist_thresh=8):
    pdb_list = Bio.PDB.PDBList()
    pdb_parser = Bio.PDB.PDBParser()
    pdb_dir = os.path.join(data_dir, &#39;Pfam-A.full&#39;, ref.name)
    pdb_file = pdb_list.retrieve_pdb_file(ref.pdb_id, pdir=pdb_dir, file_format=&#39;pdb&#39;)
    chain = pdb_parser.get_structure(ref.pdb_id, pdb_file)[0][ref.chain]
    coords = np.array([a.get_coord() for a in chain.get_atoms()])
    coords = coords[ref.pdb_start-1:ref.pdb_end]
    coords = coords[~conserved_residues[~missing_aa_seq]]
    return distance_matrix(coords, coords) &lt; dist_thresh

contact_map = get_contact_map(ref)

fig, ax = plt.subplots(1, 1, figsize=(6, 6))
ax.set_title(&#39;PDB: %s, chain %s, residues %i-%i&#39; % (ref.pdb_id, ref.chain, ref.pdb_start, ref.pdb_end))
ax.matshow(contact_map, cmap=&#39;Greys&#39;)
ax.axis(&#39;off&#39;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4oo8.ent&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_23_1.png" src="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_23_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>def roc(w, c):
    mask = ~np.eye(w.shape[0], dtype=bool)
    order = np.abs(w)[mask].argsort()[::-1]
    c_flat = c[mask][order]
    tp = np.cumsum(c_flat, dtype=float)
    fp = np.cumsum(~c_flat, dtype=float)
    tp /= tp[-1]
    fp /= fp[-1]
    return fp, tp

fig, ax = plt.subplots(1, 1, figsize=(6, 6))
fp, tp = roc(w_seq, contact_map)
ax.plot(fp, tp, &#39;k-&#39;)
grid = np.linspace(0, 1)
ax.plot(grid, grid, &#39;r--&#39;, lw=1)
ax.set_xlabel(&#39;false positive rate&#39;)
ax.set_ylabel(&#39;true positive rate&#39;)
ax.set_title(&#39;ROC&#39;)
ax.text(1, 0, &#39;AUC: %0.2f&#39; % (tp.sum() / tp.shape[0],), va=&#39;bottom&#39;, ha=&#39;right&#39;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_24_0.png" src="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_24_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>idx = contact_map.sum()
mask = ~np.eye(w_seq.shape[0], dtype=bool)
thresh = np.sort(np.abs(w_seq)[mask])[-idx]

fig, ax = plt.subplots(1, 1, figsize=(6,6))
ax.matshow(contact_map, cmap=&#39;Greys&#39;)
cmap = colors.ListedColormap([&#39;white&#39;, &#39;red&#39;])
norm = colors.BoundaryNorm([0, 0.5, 1.0], 2)
ax.matshow((np.abs(w_seq) &gt; thresh).astype(bool), cmap=cmap, norm=norm, alpha=0.5)
ax.axis(&#39;off&#39;)
ax.set_title(&#39;PDB: %s, chain %s, residues %i-%i&#39; % (ref.pdb_id, ref.chain, ref.pdb_start, ref.pdb_end))
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_25_0.png" src="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_25_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>mask = ~np.eye(w_seq.shape[0], dtype=bool)
order = np.argsort(np.abs(w_seq)[mask])

res = np.arange(ref.pdb_start, ref.pdb_end+1)
res = res[~conserved_residues[~missing_aa_seq]]
mask = ~np.eye(res.shape[0], dtype=bool)
res_res = np.dstack(np.meshgrid(res, res)[::-1])[mask]

res_pairs = res_res[order[-100:]]

pdb_list = Bio.PDB.PDBList()
pdb_parser = Bio.PDB.PDBParser()
pdb_dir = os.path.join(data_dir, &#39;Pfam-A.full&#39;, ref.name)
pdb_file = pdb_list.retrieve_pdb_file(ref.pdb_id, pdir=pdb_dir, file_format=&#39;pdb&#39;)
chain = pdb_parser.get_structure(ref.pdb_id, pdb_file)[0][ref.chain]
view = nglview.show_biopython(chain)
# view.clear_representations()
# view.add_licorice()
# view.add_surface(opacity=0.1)
# colors = [&#39;0x0000FF&#39;] * len(chain)
# view._set_color_by_residue(colors, component_index=0, repr_index=0)
view
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4oo8.ent&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "516972579b2f4d9eb70cb9e5d59fe35b", "version_minor": 0, "version_major": 2}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [19]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>fig, ax = plt.subplots(1, 1, figsize=(8, 8))

max_auc = 0

msa_int = fem.discrete.fit.categorize(msa)[0]
msa_oh = fem.discrete.fit.one_hot(msa_int[~conserved_residues], degs=[1])[0].todense()
tmp = np.cov(msa_oh)

for i in range(refs.shape[0]):
    ref = refs.iloc[i]
    seq = msa[:, ref.seq]
    missing_aa_seq = seq == &#39;-&#39;
    seq_int = msa_int[:, ref.seq][~conserved_residues]
    w_idx = (mm[:-1] + seq_int)[~missing_aa_seq[~conserved_residues]]
#     w_seq = w[1][np.ix_(w_idx, w_idx)]
    w_seq = tmp[np.ix_(w_idx, w_idx)]
    contact_map = get_contact_map(ref)
    fp, tp = roc(w_seq, contact_map)
    ax.plot(fp, tp, label=&#39;%s%s, %i-%i&#39; % (ref.pdb_id, ref.chain, ref.pdb_start, ref.pdb_end))
    max_auc = max(max_auc, tp.sum() / tp.shape[0])

grid = np.linspace(0, 1)
ax.plot(grid, grid, &#39;r--&#39;, lw=1)
ax.set_xlabel(&#39;false positive rate&#39;)
ax.set_ylabel(&#39;true positive rate&#39;)
ax.set_title(&#39;ROC&#39;)
ax.text(1, 0, &#39;max AUC: %0.2f&#39; % (max_auc,), va=&#39;bottom&#39;, ha=&#39;right&#39;)
plt.legend()
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4oo8.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4cmq.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4oo8.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4zt0.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5f9r.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4un4.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4zt0.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5fw2.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5b2t.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4un5.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4cmp.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4cmq.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5fw3.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5fq5.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4cmp.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4zt9.ent&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_27_1.png" src="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_27_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [20]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>msa_int = fem.discrete.fit.categorize(msa[~conserved_residues])[0]
msa_oh = fem.discrete.fit.one_hot(msa_int, degs=[1])[0].todense()
tmp = np.cov(msa_oh)
fig, ax = plt.subplots(1, 3, figsize=(12,4))
ax[0].imshow(w[1], cmap = &#39;seismic&#39;, vmin=-.1, vmax=.1)
ax[1].imshow(tmp, cmap = &#39;seismic&#39;, vmin=-.1, vmax=.1)
ax[2].imshow(w[1]-tmp, cmap = &#39;seismic&#39;, vmin=-.1, vmax=.1)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_28_0.png" src="../../../_images/notebooks_discrete_drafts_multiple_sequence_alignments_28_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [21]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># # get 100 most extreme values of w[1]
# i = np.arange(w[1].shape[0])
# mask = ~np.eye(w[1].shape[0], dtype=bool)
# order = np.argsort(np.abs(w[1])[mask])
# ii = np.dstack(np.meshgrid(i, i)[::-1])[mask][order][::-1]
# mi = np.repeat(np.arange(mm.shape[0]-1), np.diff(mm))
# ij = set()
# index = 0
# while len(ij) &lt; 100:
#     ij.add((mi[ii[index, 0]], mi[ii[index, 1]]))
#     index += 1
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [22]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># from pymol import cmd

# def plot_pdb(pdb_id, chain, pdb_start, pdb_end):
#     return 0

# cmd.extend(&#39;plot_pdb&#39;, plot_pdb)


# ? pymol.cmd.extract
# fetch &#39;pdb_id&#39;
# extract new_obj, resi pdb_start-pdb_end
# color slate, new_obj
# set cartoon_transparency, 0.5, &#39;pdb_id&#39;
# color gray80, &#39;pdb_id&#39;
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [23]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># pdb_id = cas9_refs.iloc[i].pdb_id
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [24]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># pymol.cmd.fetch(pdb_id, path=&#39;./&#39;)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [25]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># res_idx = np.argwhere(msa[:,0] != &#39;-&#39;).squeeze()
# m_cumsum = np.insert(m.cumsum(), 0, 0)
# m1 = m_cumsum[:-1][res_idx]
# m2 = m_cumsum[1:][res_idx]
# v = np.empty((m2.max(), m2.max()))

# res1, res2, x = [], [], []
# for i, (i1, i2) in enumerate(zip(m1, m2)):
#     for j, (j1, j2) in enumerate(zip(m1, m2)):
#         res1.append(i)
#         res2.append(j)
#         x.append(np.abs(w[i1:i2, j1:j2]).sum())


# res1 = np.array(res1) + 130
# res2 = np.array(res2) + 130
# x = np.array(x)
# order = np.argsort(x)[::-1]

# res1 = res1[order]
# res2 = res2[order]
# x = x[order]
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [26]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># print &#39;5FQ5&#39;
# for row in np.vstack((res1, res2, x)).T[:500]:
#     print int(row[0]), int(row[1]), row[2]
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [27]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># dir(pymol)
# ? pymol.cmd.save
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [28]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># pymol.cmd.set(&#39;grid_mode&#39;, 1)
# # gird_slot
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [29]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># pymol.cmd.loadall(os.path.join(pf_dir, &#39;*.cif&#39;))
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [30]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># pymol.cmd.png(filename = os.path.join(pf_dir, &#39;all.png&#39;))
# pymol.cmd.save(filename = os.path.join(pf_dir, &#39;all.png&#39;))
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [31]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># def plot_pdb(pdbid, pf_dir):
#     pdbid = pdbid.lower()
#     pymol.cmd.fetch(pdbid, path=pf_dir)
#     pymol.cmd.load(filename = os.path.join(pf_dir, pdbid+&#39;.cif&#39;))
#     pymol.cmd.png(filename = os.path.join(pf_dir, pdbid+&#39;.png&#39;))

# pymol.cmd.extend(&#39;plot_pdb&#39;, plot_pdb)

# # for pdbid in pdbmap[pdbmap[&#39;pf&#39;].str.contains(&#39;PF16592&#39;)].index:
# #     plot_pdb(pdbid, pf_dir)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [32]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># pymol -qcr &lt;script.py&gt;
# ftp://ftp.ebi.ac.uk/pub/databases/Pfam/releases/Pfam31.0/
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [33]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># import Bio
# from Bio import SeqIO
# msa = Bio.SeqIO.parse(os.path.join(data_dir, &#39;PF16592_ncbi.txt&#39;), &#39;fasta&#39;)
# msa = np.array([np.array(s.seq) for s in msa]).T
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [34]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># # random pdb
# pdb = pdbmap.sample()
# pfam = pf_info[pf_info.index.str.contains(pdb[&#39;pf&#39;][0])]
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2018, Joe McKenna.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.7.9.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>