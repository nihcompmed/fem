<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>&lt;no title&gt; &mdash; fem  documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../../../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../../../_static/scipy.css" type="text/css" >
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/js/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" >
    <link rel="search" title="Search" href="../../../search.html" >
    <link rel="top" title="fem  documentation" href="../../../index.html" > 
  </head>
  <body>

  <div class="container">
    <div class="header">
    </div>
  </div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
        <li class="active"><a href="https://www.niddk.nih.gov/research-funding/at-niddk/labs-branches/LBM">LBM</a></li>
        <li class="active"><a href="https://pypi.python.org/pypi/fem">fem</a></li>
	
        <li class="active"><a href="../../../index.html">fem  documentation</a></li>
	 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../../../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../../../f-modindex.html" title="Fortran Module Index"
           >fortran modules</a>
      </li>
      <li class="active">
        <a href="../../../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 9ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>import fem
%matplotlib inline
import matplotlib.pyplot as plt
from matplotlib import patches, colors
import numpy as np
import pandas as pd
from scipy.spatial import distance_matrix
import sys, os, time, Bio.PDB, warnings, nglview
from Bio import BiopythonWarning
warnings.simplefilter(&#39;ignore&#39;, BiopythonWarning)
data_dir = &#39;../../../../data/msa&#39;
sys.path.append(data_dir)
from parse_pfam import parse_pfam
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>pfam, pdb_refs = parse_pfam(data_dir)
print &#39;total MSAs: %i, total PDB refs: %i&#39; % (pfam.shape[0], pdb_refs.shape[0])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
total MSAs: 16479, total PDB refs: 207746
</pre></div></div>
</div>
<p>Subset the Pfam table <code class="docutils literal notranslate"><span class="pre">pfam</span></code> to contain only the families that contain
at least one sequence with a reference to a PDB structure.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>pfam = pfam[pfam.index.isin(pdb_refs.index)]
print &#39;MSAs with PDB refs: %i&#39; % (pfam.shape[0],)
pfam[&#39;size&#39;] = pfam[&#39;res&#39;]*pfam[&#39;seq&#39;]
pfam.sort_values(by=&#39;size&#39;, inplace=True)
pfam.tail()
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>pdb_refs[&#39;res&#39;] = pdb_refs[&#39;pdb_end&#39;] - pdb_refs[&#39;pdb_start&#39;] + 1
pdb_refs.sort_values(by=&#39;res&#39;, ascending=False, inplace=True)
pdb_refs.head()
# random family
ac = pfam.sample().index[0]
fam = pfam.loc[ac]
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>def direct_information(fam, cache=True):

    fam_dir = os.path.join(data_dir, &#39;Pfam-A.full&#39;, fam.name)
    direct_info_file = os.path.join(fam_dir, &#39;direct_info.npy&#39;)

    if cache and os.path.exists(direct_info_file):
        return np.load(direct_info_file)

    msa = np.load(os.path.join(fam_dir, &#39;msa.npy&#39;))

    aa = np.array([np.unique(s) for s in msa])
    one_aa = np.array([len(a) == 1 for a in aa])
    two_aa = np.array([len(a) == 2 for a in aa])
    missing_aa_res = np.array([&#39;-&#39; in a for a in aa])
    conserved_residues = one_aa | (two_aa &amp; missing_aa_res)

    m = np.array([len(a) for a in aa])
    m = m[~conserved_residues]
    n_residues = m.shape[0]
    mm = np.insert(m.cumsum(), 0, 0)
    w_idx = np.vstack((mm[:-1], mm[1:])).T

    w_file = os.path.join(fam_dir, &#39;w.npy&#39;)
    d_file = os.path.join(fam_dir, &#39;d.npy&#39;)
    if cache and os.path.exists(w_file) and os.path.exists(d_file):
        w = np.load(w_file)
        d = np.load(d_file)
    else:
        start = time.time()
        w, d = fem.discrete.fit.fit(msa[~conserved_residues], iters=10)
        end = time.time()
        print &#39;fit time: %.02f sec&#39; % (end-start,)
        w = np.hstack(w.values())
        np.save(w_file, w)
        np.save(d_file, d)

    direct_info = np.zeros((n_residues, n_residues))
    for i, ii in enumerate(w_idx):
        for j, jj in enumerate(w_idx):
            p = np.exp(w[ii[0]:ii[1], jj[0]:jj[1]])
            pi, pj = p.sum(axis=1), p.sum(axis=0)
            p /= p.sum()
            pi /= pi.sum()
            pj /= pj.sum()
            direct_info[i,j] = (p*np.log(p/np.outer(pi, pj))).sum()

    np.save(direct_info_file, direct_info)
    return direct_info
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>def contact_map(ref, dist_thresh=8):
    fam_dir = os.path.join(data_dir, &#39;Pfam-A.full&#39;, fam.name)
    msa = np.load(os.path.join(fam_dir, &#39;msa.npy&#39;))
    aa = np.array([np.unique(s) for s in msa])
    one_aa = np.array([len(a) == 1 for a in aa])
    two_aa = np.array([len(a) == 2 for a in aa])
    missing_aa_res = np.array([&#39;-&#39; in a for a in aa])
    conserved_residues = one_aa | (two_aa &amp; missing_aa_res)
    seq = msa[:, ref.seq]
    missing_aa_seq = seq == &#39;-&#39;

    pdb_list = Bio.PDB.PDBList()
    pdb_parser = Bio.PDB.PDBParser()
    pdb_dir = os.path.join(data_dir, &#39;Pfam-A.full&#39;, ref.name)
    pdb_file = pdb_list.retrieve_pdb_file(ref.pdb_id, pdir=pdb_dir, file_format=&#39;pdb&#39;)
    chain = pdb_parser.get_structure(ref.pdb_id, pdb_file)[0][ref.chain]
    coords = np.array([a.get_coord() for a in chain.get_atoms()])
    coords = coords[ref.pdb_start-1:ref.pdb_end]

    coords = coords[~conserved_residues[~missing_aa_seq]]
    return distance_matrix(coords, coords) &lt; dist_thresh

def predict_contacts(ref, direct_info, top, k=1):
    fam_dir = os.path.join(data_dir, &#39;Pfam-A.full&#39;, fam.name)
    msa = np.load(os.path.join(fam_dir, &#39;msa.npy&#39;))
    aa = np.array([np.unique(s) for s in msa])
    one_aa = np.array([len(a) == 1 for a in aa])
    two_aa = np.array([len(a) == 2 for a in aa])
    missing_aa_res = np.array([&#39;-&#39; in a for a in aa])
    conserved_residues = one_aa | (two_aa &amp; missing_aa_res)

    seq = msa[:, ref.seq]
    missing_aa_seq = seq == &#39;-&#39;
    di_idx = np.arange((~conserved_residues).sum())
    di_idx = di_idx[~missing_aa_seq[~conserved_residues]]
    di = direct_info[np.ix_(di_idx, di_idx)]
    mask = np.triu(np.ones(di.shape[0], dtype=bool), k=k)
    thresh = np.sort(np.abs(di)[mask])[-top]
    di[~mask] = 0
    predicted_contacts = np.where(di &gt;= thresh)
    return predicted_contacts

def roc(x, c):
    mask = np.triu(np.ones(di.shape[0], dtype=bool), k=5)
    order = x[mask].argsort()[::-1]
    c_flat = c[mask][order]
    tp = np.cumsum(c_flat, dtype=float)
    fp = np.cumsum(~c_flat, dtype=float)
    tp /= tp[-1]
    fp /= fp[-1]
    return fp, tp
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>auc = []

for i in range(100, len(pfam)):

    fam = pfam.iloc[i]

    start = time.time()
    direct_info = direct_information(fam, cache=False)
    end = time.time()

    fam_dir = os.path.join(data_dir, &#39;Pfam-A.full&#39;, fam.name)
    msa = np.load(os.path.join(fam_dir, &#39;msa.npy&#39;))
    aa = np.array([np.unique(s) for s in msa])
    one_aa = np.array([len(a) == 1 for a in aa])
    two_aa = np.array([len(a) == 2 for a in aa])
    missing_aa_res = np.array([&#39;-&#39; in a for a in aa])
    conserved_residues = one_aa | (two_aa &amp; missing_aa_res)

    refs = pdb_refs[pdb_refs.index.str.contains(fam.name)]

    ref_auc = []
    for j in range(refs.shape[0]):
        ref = refs.iloc[j]
        seq = msa[:, ref.seq]
        missing_aa_seq = seq == &#39;-&#39;
        di_idx = np.arange((~conserved_residues).sum())
        di_idx = di_idx[~missing_aa_seq[~conserved_residues]]
        di = direct_info[np.ix_(di_idx, di_idx)]
        contacts = contact_map(ref)
        fp, tp = roc(di, contacts)
        ref_auc.append([ref.name, tp.sum() / tp.shape[0]])

    ref_auc = np.arrayref_(auc)
    max_auc = ref_auc[:,1].max()
    np.save(os.path.join(fam_dir, &#39;auc.npy&#39;), ref_auc)

    auc.append([fam.ac, max_auc, end-start])
    print i ,len(pfam), auc[-1]

np.save(os.path.join(data_dir, &#39;Pfam-A.full&#39;, &#39;auc.npy&#39;), auc)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># w_file = os.path.join(fam_dir, &#39;w.npy&#39;)
# d_file = os.path.join(fam_dir, &#39;d.npy&#39;)
# direct_info_file = os.path.join(fam_dir, &#39;direct_info.npy&#39;)
# w = np.load(w_file)
# d = np.load(d_file)
# direct_info = np.load(direct_info_file)

# seq_int = msa_int[:, ref.seq]
# seq_int = seq_int[~conserved_residues]
# w_idx = mm[:-1] + seq_int
# w_idx = w_idx[~missing_aa_seq[~conserved_residues]]
# w_seq = w[np.ix_(w_idx, w_idx)]

# fig, ax = plt.subplots(1, 1, figsize=(6, 6))
# scale = 1e-1 * np.abs(w_seq).max()
# ax.matshow(w_seq, cmap=plt.cm.seismic, vmin=-scale, vmax=scale)
# ax.axis(&#39;off&#39;)
# ax.set_title(&#39;PDB: %s, chain %s, residues %i-%i&#39; % (ref.pdb_id, ref.chain, ref.pdb_start, ref.pdb_end))
# plt.show()
</pre></div>
</div>
</div>


          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2018, Joe McKenna.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.7.9.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>