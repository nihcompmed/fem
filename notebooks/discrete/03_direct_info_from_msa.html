<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>Direct information from a multiple sequence alignment &mdash; fem  documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../../_static/scipy.css" type="text/css" >
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/js/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" >
    <link rel="search" title="Search" href="../../search.html" >
    <link rel="top" title="fem  documentation" href="../../index.html" >
    <link rel="up" title="Examples" href="../../examples.html" >
    <link rel="next" title="Currency trading strategies" href="04_currency_trading.html" >
    <link rel="prev" title="Anagram solver" href="02_anagram_solver.html" > 
  </head>
  <body>

  <div class="container">
    <div class="header">
    </div>
  </div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
        <li class="active"><a href="https://www.niddk.nih.gov/research-funding/at-niddk/labs-branches/LBM">LBM</a></li>
        <li class="active"><a href="https://pypi.python.org/pypi/fem">fem</a></li>
	
        <li class="active"><a href="../../index.html">fem  documentation</a></li>
	
          <li class="active"><a href="../../examples.html" accesskey="U">Examples</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../../f-modindex.html" title="Fortran Module Index"
           >fortran modules</a>
      </li>
      <li class="active">
        <a href="../../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
      <li class="active">
        <a href="04_currency_trading.html" title="Currency trading strategies"
           accesskey="N">next</a>
      </li>
      <li class="active">
        <a href="02_anagram_solver.html" title="Anagram solver"
           accesskey="P">previous</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="02_anagram_solver.html"
                        title="previous chapter">Anagram solver</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="04_currency_trading.html"
                        title="next chapter">Currency trading strategies</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 9ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<div class="section" id="Direct-information-from-a-multiple-sequence-alignment">
<h1>Direct information from a multiple sequence alignment<a class="headerlink" href="#Direct-information-from-a-multiple-sequence-alignment" title="Permalink to this headline">Â¶</a></h1>
<p><a class="reference external" href="https://mybinder.org/v2/gh/nihcompmed/fem/master?filepath=doc%2Fnotebooks%2Fdiscrete%2F03_direct_info_from_msa.ipynb"><img alt="Binder" src="https://mybinder.org/badge.svg" /></a></p>
<p>In this example, we compute coupling strengths between residues of the
CRISPR-Cas9 protein amino acid sequence from multiple sequence alignment
data. We demonstrate that a statistic called <em>direct information</em>
<a class="reference external" href="https://doi.org/10.1073/pnas.1111471108">[1]</a> computed from these
couplings is predictive of contacts in observed 3D conformations of the
sequence.</p>
<p>We start by loading the necessary packages and functions. We collect and
parse MSA data from the <a class="reference external" href="https://pfam.xfam.org/">Pfam database</a> using
the <code class="docutils literal notranslate"><span class="pre">parse_pfam</span></code> function in <a class="reference external" href="../../static/parse_pfam.py">this
script</a>. The function downloads the full
current release of the Pfam database, creates a local directory
structure with the MSA data for each family and any cross-references
from sequences in each family to structures in the <a class="reference external" href="https://www.rcsb.org/">Protein Data
Bank</a>, then returns pandas DataFrames that
detail information about the MSAs and PDB cross-references.</p>
<p>The MSA and PDB cross-reference data for the protein family/MSA with
Pfam accession code PFXXXXX are stored in files <code class="docutils literal notranslate"><span class="pre">msa.npy</span></code> and
<code class="docutils literal notranslate"><span class="pre">pdb_refs.npy</span></code> (if cross-references are found) in the
<code class="docutils literal notranslate"><span class="pre">Pfam-A.full/PFXXXXX</span></code> subdirectory of <code class="docutils literal notranslate"><span class="pre">data_dir</span></code> defined below.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>import matplotlib.pyplot as plt
from matplotlib import patches
import numpy as np
import pandas as pd
from scipy.spatial import distance_matrix
import fem, sys, os, time, Bio.PDB, nglview, warnings
pdb_list = Bio.PDB.PDBList()
pdb_parser = Bio.PDB.PDBParser()
data_dir = &#39;../../../data/msa&#39;
sys.path.append(data_dir)
from parse_pfam import parse_pfam
from Bio import BiopythonWarning
warnings.simplefilter(&#39;ignore&#39;, BiopythonWarning)
%matplotlib inline
from ipymol import viewer
viewer.start()
pymol = viewer._server
from IPython.display import Image
</pre></div>
</div>
</div>
<p>Next, we get pandas DataFrames <code class="docutils literal notranslate"><span class="pre">pfam</span></code> and <code class="docutils literal notranslate"><span class="pre">pdb_refs</span></code> detailing
information for all protein families in the Pfam database and references
from MSA sequences to PDB structures.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>pfam, pdb_refs = parse_pfam(data_dir)
print &#39;total MSAs: %i, total PDB refs: %i&#39; % (pfam.shape[0], pdb_refs.shape[0])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
total MSAs: 16479, total PDB refs: 207746
</pre></div></div>
</div>
<p>Each row in <code class="docutils literal notranslate"><span class="pre">pfam</span></code> contains information about a single MSA. The
columns of <code class="docutils literal notranslate"><span class="pre">pfam</span></code> are <code class="docutils literal notranslate"><span class="pre">res</span></code>: the number of residues in each sequence
of the alignment, <code class="docutils literal notranslate"><span class="pre">seq</span></code>: the number of sequences in the alignment. Now
letâs add a column <code class="docutils literal notranslate"><span class="pre">size=res*seq</span></code> and sort by that column to see which
families contain the most data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>pfam[&#39;size&#39;] = pfam[&#39;res&#39;] * pfam[&#39;seq&#39;]
pfam.sort_values(by=&#39;size&#39;, ascending=False, inplace=True)
pfam.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>res</th>
      <th>seq</th>
      <th>pdb_refs</th>
      <th>size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>PF00005</th>
      <td>2386</td>
      <td>369723</td>
      <td>407</td>
      <td>882159078</td>
    </tr>
    <tr>
      <th>PF00069</th>
      <td>3194</td>
      <td>236455</td>
      <td>3910</td>
      <td>755237270</td>
    </tr>
    <tr>
      <th>PF07690</th>
      <td>3427</td>
      <td>214283</td>
      <td>23</td>
      <td>734347841</td>
    </tr>
    <tr>
      <th>PF00067</th>
      <td>4853</td>
      <td>85020</td>
      <td>768</td>
      <td>412602060</td>
    </tr>
    <tr>
      <th>PF00501</th>
      <td>3767</td>
      <td>87704</td>
      <td>145</td>
      <td>330380968</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Each row in the PDB references table <code class="docutils literal notranslate"><span class="pre">pdb_refs</span></code> contains information
about a cross-reference between a protein family sequence in the Pfam
database and a protein structure in the PDB database. The columns of the
table are <code class="docutils literal notranslate"><span class="pre">seq</span></code>: the index (starting at 0) of a sequence in the
protein family, <code class="docutils literal notranslate"><span class="pre">uniprot_id</span></code>: the ID of the sequence in the
<a class="reference external" href="https://www.uniprot.org/help/uniprotkb">UniProtKB</a> database,
<code class="docutils literal notranslate"><span class="pre">uniprot_start</span></code>/<code class="docutils literal notranslate"><span class="pre">uniprot_end</span></code>: the start and end residue positions
of the UniProtKB sequence that appears in the MSA, <code class="docutils literal notranslate"><span class="pre">pdb_id</span></code>: the PDB
ID, <code class="docutils literal notranslate"><span class="pre">chain</span></code>: the PDB protein structure chain,
<code class="docutils literal notranslate"><span class="pre">pdb_start</span></code>/<code class="docutils literal notranslate"><span class="pre">pdb_end</span></code>: the start and end residue positions of the
PDB sequence that appears in the MSA. Letâs create a column <code class="docutils literal notranslate"><span class="pre">res</span></code> that
contains the length of the sequence and sort by that column.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>pdb_refs[&#39;res&#39;] = pdb_refs[&#39;pdb_end&#39;] - pdb_refs[&#39;pdb_start&#39;] + 1
pdb_refs.sort_values(by=&#39;res&#39;, ascending=False, inplace=True)
pdb_refs.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>seq</th>
      <th>uniprot_id</th>
      <th>uniprot_start</th>
      <th>uniprot_end</th>
      <th>pdb_id</th>
      <th>chain</th>
      <th>pdb_start</th>
      <th>pdb_end</th>
      <th>res</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>PF11894</th>
      <td>578</td>
      <td>NU205_HUMAN</td>
      <td>14</td>
      <td>1684</td>
      <td>5IJN</td>
      <td>J</td>
      <td>14</td>
      <td>1684</td>
      <td>1671</td>
    </tr>
    <tr>
      <th>PF11894</th>
      <td>578</td>
      <td>NU205_HUMAN</td>
      <td>14</td>
      <td>1684</td>
      <td>5IJN</td>
      <td>P</td>
      <td>14</td>
      <td>1684</td>
      <td>1671</td>
    </tr>
    <tr>
      <th>PF11894</th>
      <td>578</td>
      <td>NU205_HUMAN</td>
      <td>14</td>
      <td>1684</td>
      <td>5IJN</td>
      <td>D</td>
      <td>14</td>
      <td>1684</td>
      <td>1671</td>
    </tr>
    <tr>
      <th>PF11894</th>
      <td>578</td>
      <td>NU205_HUMAN</td>
      <td>14</td>
      <td>1684</td>
      <td>5IJN</td>
      <td>V</td>
      <td>14</td>
      <td>1684</td>
      <td>1671</td>
    </tr>
    <tr>
      <th>PF02463</th>
      <td>2434</td>
      <td>SMC1_YEAST</td>
      <td>3</td>
      <td>1213</td>
      <td>1W1W</td>
      <td>C</td>
      <td>3</td>
      <td>1213</td>
      <td>1211</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Weâll examine the particular protein family with Pfam accesion code
PF16592. This protein family corresponds to the REC lobe of
CRISPR-associated endonuclease Cas9. The REC lobe and the NUC lobe of
Cas9 fold to present a positively charged groove at their interface
which accommodates the negatively charged sgRNA: target DNA
heteroduplex. <a class="reference external" href="https://www.ncbi.nlm.nih.gov/pubmed/24529477">[2]</a>
Weâll isolate the family of interest from the <code class="docutils literal notranslate"><span class="pre">pfam</span></code> DataFrame in the
<code class="docutils literal notranslate"><span class="pre">fam</span></code> variable.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span># Cas 9 family accesion code
ac = &#39;PF16592&#39;
# store the family of interest in the &#39;fam&#39; variable
fam = pfam.loc[ac]
print &#39;size rank: %i of %i&#39; % (pfam[&#39;size&#39;].rank(ascending=False)[fam.name].astype(int), pfam.shape[0])

# local directory containing data for this MSA
fam_dir = os.path.join(data_dir, &#39;Pfam-A.full&#39;, fam.name)
# the residue symbols array that is the MSA
msa = np.load(os.path.join(fam_dir, &#39;msa.npy&#39;))

# determine which residues are the same across all sequences, excluding gaps
aa = np.array([np.unique(s) for s in msa])
one_aa = np.array([len(a) == 1 for a in aa])
two_aa = np.array([len(a) == 2 for a in aa])
missing_aa_res = np.array([&#39;-&#39; in a for a in aa])
conserved_residues = one_aa | (two_aa &amp; missing_aa_res)

# the number of unique amino acids (or gap symbol) that appear at each residue
m = np.array([len(a) for a in aa])
m = m[~conserved_residues]
n_residues = m.shape[0]

pfam[pfam.index == ac]
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
size rank: 7142 of 16479
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>res</th>
      <th>seq</th>
      <th>pdb_refs</th>
      <th>size</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>PF16592</th>
      <td>1079</td>
      <td>146</td>
      <td>21</td>
      <td>157534</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>One can classify a residue from the perspective of the MSA as a
conserved residue, meaning that in every sequence of the MSA, either a
gap or the same amino acid is observed. One can also classify a residue
from the perspective of the sequence as a gap, i.e.&nbsp;an insertion that
Pfamâs aligning algorithm made in the sequence in order to compare like
residues across sequences. Therefore, each sequence-residue symbol is in
one of four classes according to whether it is a conserved residue or
not and where it is a gap or not. We color code each sequence-residue
symbol for the MSA of interest.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>code = np.zeros(msa.shape, dtype=int)
code[conserved_residues] = 2
for j, s in enumerate(msa.T):
    code[s == &#39;-&#39;, j] += 1

fig, ax = plt.subplots(1, 1, figsize=(16, 4))
ax.set_ylabel(&#39;sequence&#39;)
ax.set_xlabel(&#39;residue&#39;)
cmap = plt.cm.get_cmap(&#39;plasma&#39;, 4)
ax.matshow(code.T, aspect=&#39;auto&#39;, cmap=cmap)
labels = [&#39;active&#39;, &#39;alignment gap&#39;, &#39;conserved residue&#39;, &#39;alignment gap and conserved residue&#39;]
handles = [patches.Patch(color=cmap(i), label=labels[i]) for i in range(4)]
plt.legend(handles=handles, ncol=4)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_discrete_03_direct_info_from_msa_12_0.png" src="../../_images/notebooks_discrete_03_direct_info_from_msa_12_0.png" />
</div>
</div>
<p>Now, we compute the residue coupling strengths and the direct
information from the MSA. The MSA is a set of sequences
<span class="math notranslate nohighlight">\(\text{MSA}=\{s_1,\ldots,s_n\}\)</span> and each nonconserved residue
<span class="math notranslate nohighlight">\(r_i\)</span>, <span class="math notranslate nohighlight">\(i=1,\ldots,m\)</span>, in the alignment takes</p>
<div class="math notranslate nohighlight">
\[m_i = \left|\{a : r_i=a\text{ for some sequence }s=(r_1,\ldots,r_m)\in\text{MSA}\}\right|\]</div>
<p>unique empircal values in the alignment. In the following, let
<span class="math notranslate nohighlight">\(M_i=\sum_{\tilde{i}&lt;i}m_{\tilde{i}}\)</span> for <span class="math notranslate nohighlight">\(i=1,\ldots,m\)</span> and
let <span class="math notranslate nohighlight">\(e_i\)</span> denote the <span class="math notranslate nohighlight">\(i^{th}\)</span> canonical basis vector of the
shape implied by context.</p>
<p>We use FEM to infer the couplings <span class="math notranslate nohighlight">\(W\)</span> assuming that the
probability of residue <span class="math notranslate nohighlight">\(r_i\)</span> being amino acid <span class="math notranslate nohighlight">\(a_k\)</span> for any
sequence with one-hot encoding <span class="math notranslate nohighlight">\(\sigma\)</span> is given by</p>
<div class="math notranslate nohighlight">
\[p(r_i=a_k~|~\{r_1,\ldots,r_n\}\setminus \{r_i\})={\exp e_{M_i+k}^TW\sigma\over\sum_{j=1}^{m_i}\exp e_{M_i+j}^TW\sigma},\quad i=1,\ldots,m,~k=1,\ldots,m_i.\]</div>
<p>Specifically, we call
<code class="docutils literal notranslate"><span class="pre">fem.discrete.model.fit(msa[~conserved_residues])</span></code> below, where
<code class="docutils literal notranslate"><span class="pre">msa</span></code> is an array of symbols with each row storing residue data and
each column storing sequence data, to return <span class="math notranslate nohighlight">\(W\)</span> and the running
discrepancies from the fit.</p>
<p>After computing <span class="math notranslate nohighlight">\(W\)</span>, we compute the <em>direct information</em> for each
pair of nonconserved residues. The direct information of residues
<span class="math notranslate nohighlight">\(r_i\)</span> and <span class="math notranslate nohighlight">\(r_j\)</span> is</p>
<div class="math notranslate nohighlight">
\[DI(r_i, r_j)=\sum_{k_1=1}^{m_{i_1}}\sum_{k_2=1}^{m_{i_2}} p(r_{i_1}=a_{k_1}, r_{i_2}=a_{k_2}) \ln {p(r_{i_1}=a_{k_1}, r_{i_2}=a_{k_2}) \over p(r_{i_1}=a_{k_1})~p(r_{i_2}=a_{k_2})}\]</div>
<p>where the joint and marginal probablities are computed over subsequences
containing only residues <span class="math notranslate nohighlight">\(r_i\)</span> and <span class="math notranslate nohighlight">\(r_j\)</span>:</p>
<div class="math notranslate nohighlight">
\[p(r_{i_1}=a_{k_1}, r_{i_2}=a_{k_2})={\exp e_{M_{i_1}+k_1}^TWe_{M_{i_2}+k_2} \over
\sum_{j_1=1}^{m_{i_1}}\sum_{j_2=1}^{m_{i_2}}\exp e_{M_{i_1}+j_1}^TWe_{M_{i_2}+j_2}},\]</div>
<div class="math notranslate nohighlight">
\[p(r_{i_1}=a_{k_1})={\sum_{k_2=1}^{m_{i_2}} p(r_{i_1}=a_{k_1}, r_{i_2}=a_{k_2}) \over \sum_{k_1=1}^{m_{i_1}}\sum_{k_2=1}^{m_{i_2}}p(r_{i_1}=a_{k_1}, r_{i_2}=a_{k_2})},\]</div>
<p>and <span class="math notranslate nohighlight">\(p(r_{i_2}=a_{k_2})\)</span> is defined similarly.</p>
<p>We plot the running discrepancies from the fit and heat maps of
<span class="math notranslate nohighlight">\(W\)</span> and the direct information below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>def direct_information(msa, cache=True):

    w_file = os.path.join(fam_dir, &#39;w.npy&#39;)
    disc_file = os.path.join(fam_dir, &#39;disc.npy&#39;)
    if cache and os.path.exists(w_file) and os.path.exists(disc_file):
        w = np.load(w_file)
        disc = np.load(disc_file)
    else:
        model = fem.discrete.model()
        start = time.time()
        model.fit(msa[~conserved_residues], iters=10)
        end = time.time()
        print &#39;fit time: %.02f sec&#39; % (end-start,)
        w = np.hstack(model.w.values())
        disc = model.disc
        np.save(w_file, w)
        np.save(disc_file, disc)

    direct_info_file = os.path.join(fam_dir, &#39;direct_info.npy&#39;)
    if cache and os.path.exists(direct_info_file):
        direct_info = np.load(direct_info_file)
    else:
        mm = np.insert(m.cumsum(), 0, 0)
        w_idx = np.vstack((mm[:-1], mm[1:])).T
        direct_info = np.zeros((n_residues, n_residues))
        for i, ii in enumerate(w_idx):
            for j, jj in enumerate(w_idx):
                p = np.exp(w[ii[0]:ii[1], jj[0]:jj[1]])
                pi, pj = p.sum(axis=1), p.sum(axis=0)
                p /= p.sum()
                pi /= pi.sum()
                pj /= pj.sum()
                direct_info[i,j] = (p*np.log(p/np.outer(pi, pj))).sum()
        np.save(direct_info_file, direct_info)

    return direct_info, w, disc

direct_info, w, disc = direct_information(msa, cache=False)

fig, ax = plt.subplots(1, 3, figsize=(12,4))
for d in disc:
    ax[0].plot(d, &#39;k-&#39;, lw=0.1)
ax[0].set_xlabel(&#39;iteration&#39;)
ax[0].set_ylabel(&#39;discrepancy&#39;)
scale = 1e-1 * np.abs(w).max()
ax[1].matshow(w, cmap=&#39;seismic&#39;, vmin=-scale, vmax=scale)
ax[1].set_title(&#39;Pfam: %s&#39; % (fam.name,))
scale = 1e-1 * np.abs(direct_info).max()
ax[2].matshow(direct_info, cmap=&#39;seismic&#39;, vmin=0, vmax=scale)
ax[2].set_title(&#39;direct info&#39;)
for a in ax[1:]:
    a.axis(&#39;off&#39;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
fit time: 18.00 sec
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_discrete_03_direct_info_from_msa_14_1.png" src="../../_images/notebooks_discrete_03_direct_info_from_msa_14_1.png" />
</div>
</div>
<p>Next, we examine the extent to direct information is predictive of
residue contacts of the 3D conformations of sequences in the MSA.
Several sequences in this family contain cross-references to PDB
structures. Weâll isolate these references from the <code class="docutils literal notranslate"><span class="pre">pdb_refs</span></code>
DataFrame in the <code class="docutils literal notranslate"><span class="pre">refs</span></code> variable.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>refs = pdb_refs[pdb_refs.index.str.contains(fam.name)]
refs.head()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>seq</th>
      <th>uniprot_id</th>
      <th>uniprot_start</th>
      <th>uniprot_end</th>
      <th>pdb_id</th>
      <th>chain</th>
      <th>pdb_start</th>
      <th>pdb_end</th>
      <th>res</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>PF16592</th>
      <td>70</td>
      <td>CAS9_STRP1</td>
      <td>181</td>
      <td>712</td>
      <td>4OO8</td>
      <td>A</td>
      <td>181</td>
      <td>712</td>
      <td>532</td>
    </tr>
    <tr>
      <th>PF16592</th>
      <td>70</td>
      <td>CAS9_STRP1</td>
      <td>181</td>
      <td>712</td>
      <td>4CMQ</td>
      <td>A</td>
      <td>181</td>
      <td>712</td>
      <td>532</td>
    </tr>
    <tr>
      <th>PF16592</th>
      <td>70</td>
      <td>CAS9_STRP1</td>
      <td>181</td>
      <td>712</td>
      <td>4OO8</td>
      <td>D</td>
      <td>181</td>
      <td>712</td>
      <td>532</td>
    </tr>
    <tr>
      <th>PF16592</th>
      <td>70</td>
      <td>CAS9_STRP1</td>
      <td>181</td>
      <td>712</td>
      <td>4ZT0</td>
      <td>A</td>
      <td>181</td>
      <td>712</td>
      <td>532</td>
    </tr>
    <tr>
      <th>PF16592</th>
      <td>70</td>
      <td>CAS9_STRP1</td>
      <td>181</td>
      <td>712</td>
      <td>5F9R</td>
      <td>B</td>
      <td>181</td>
      <td>712</td>
      <td>532</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Next, we overlay the greatest direct information pairs on the contact
maps of the PDB structures cross-referenced from sequences in the MSA.
We indicate the percentage of the greatest direct information pairs that
are contacts of the PDB in the title of each subplot. A PDB contact map
is a binary image where a pixel value is 1 if the corresponding pair of
residues is less than a distance threshold (we use 10 angstroms below)
and 0 otherwise.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>def contact_map(ref, dist_thresh=10):
    seq = msa[:,ref.seq]
    pdb_file = pdb_list.retrieve_pdb_file(ref.pdb_id, pdir=fam_dir, file_format=&#39;pdb&#39;)
    chain = pdb_parser.get_structure(ref.pdb_id, pdb_file)[0][ref.chain]
    coords = np.array([a.get_coord() for a in chain.get_atoms()])
    coords = coords[ref.pdb_start-1:ref.pdb_end]
    missing_aa_seq = seq == &#39;-&#39;
    coords = coords[~conserved_residues[~missing_aa_seq]]
    return distance_matrix(coords, coords) &lt; dist_thresh

def predict_contacts(seq, direct_info, top, k=2):
    missing_aa_seq = seq == &#39;-&#39;
    di_idx = np.arange((~conserved_residues).sum())
    di_idx = di_idx[~missing_aa_seq[~conserved_residues]]
    di = direct_info[np.ix_(di_idx, di_idx)]
    mask = np.triu(np.ones(di.shape[0], dtype=bool), k=k)
    thresh = np.sort(np.abs(di)[mask])[-top]
    di[~mask] = 0
    predicted_contacts = np.where(di &gt;= thresh)
    return predicted_contacts

top = 20
max_tp = 0
best_ref = refs.iloc[0]

n_refs = refs.shape[0]
r, c = int(1+(n_refs-1)/4.), 4
w, h = 12, 3*r
fig = plt.figure(figsize=(w,h))
for i in range(refs.shape[0]):
    ref = refs.iloc[i]
    seq = msa[:, ref.seq]
    contacts = contact_map(ref)
    predicted_contacts = predict_contacts(seq, direct_info, top)
    tp = contacts[predicted_contacts].sum()
    if tp &gt; max_tp:
        max_tp = tp
        best_ref = ref

    ax = fig.add_subplot(r, c, i+1)
    ax.matshow(contacts, cmap=&#39;Greys&#39;, aspect=&#39;auto&#39;)
    ax.scatter(*predicted_contacts[::-1], c=&#39;r&#39;)
    ax.set_title(&#39;%s%s, %i-%i (%02.0f%%)&#39; % (ref.pdb_id, ref.chain, ref.pdb_start, ref.pdb_end, 100.*tp/float(top)))
    ax.axis(&#39;off&#39;)

plt.suptitle(&#39;top %i contact predictions&#39; % (top,))
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4oo8.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4cmq.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4oo8.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4zt0.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5f9r.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4un4.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4zt0.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5fw2.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5b2t.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4un5.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4cmp.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4cmq.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5fw3.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5fq5.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4cmp.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4zt9.ent&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_discrete_03_direct_info_from_msa_18_1.png" src="../../_images/notebooks_discrete_03_direct_info_from_msa_18_1.png" />
</div>
</div>
<p>For the PDB with the most correctly predicted contacts, we visualize the
greatest direct information pairs on the PDB structure.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>ref = best_ref
seq = msa[:, ref.seq]
predicted_contacts = predict_contacts(seq, direct_info, top)

missing_aa_seq = seq == &#39;-&#39;
res = np.arange(ref.pdb_start-1, ref.pdb_end)
res = res[~conserved_residues[~missing_aa_seq]]
res = [res[i] for i in predicted_contacts]

pdb_file = pdb_list.retrieve_pdb_file(ref.pdb_id, pdir=fam_dir, file_format=&#39;pdb&#39;)
chain = pdb_parser.get_structure(ref.pdb_id, pdb_file)[0][ref.chain]
pdb_res = [r.get_id()[1] for r in chain.get_residues()]

view = nglview.show_biopython(chain)
colors = np.array([&#39;0xFFFFFF&#39;] * len(chain))
for i, r in enumerate(pdb_res):
    if r in res[0]:
        colors[i] = &#39;0xFF0000&#39;
    elif r in res[1]:
        colors[i] = &#39;0x00FF00&#39;
colors = list(colors)
view._set_color_by_residue(colors)
view.display()
view
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5b2t.ent&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1e5ae532dd064017b00d7ccd24b6eb51", "version_minor": 0, "version_major": 2}</script></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [19]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>def plot_pdb(ref, res):

    pymol.fetch(ref.pdb_id)
    pymol.color(&#39;white&#39;)

    for r1, r2 in zip(res[0], res[1]):
        s1 = &#39;%s/%i/CA&#39; % (ref.chain, r1)
        s2 = &#39;%s/%i/CA&#39; % (ref.chain, r2)
        pymol.distance(s1, s2)

    pymol.orient()
    pymol.hide(&#39;labels&#39;)
    pymol.ray()
    pymol.png(ref.pdb_id)

    return &#39;%s.png&#39; % (ref.pdb_id,)

ref = best_ref
seq = msa[:, ref.seq]
predicted_contacts = predict_contacts(seq, direct_info, top)

missing_aa_seq = seq == &#39;-&#39;
res = np.arange(ref.pdb_start-1, ref.pdb_end)
res = res[~conserved_residues[~missing_aa_seq]]
res = [res[i] for i in predicted_contacts]

# pymol.set(&#39;fetch_type_default&#39;, &#39;pdb1&#39;)
pymol.set(&#39;distance&#39;)
pymol.set(&#39;dash_gap&#39;, 0)
pymol.set(&#39;dash_radius&#39;, 0.35)
pymol.set(&#39;dash_color&#39;, &#39;red&#39;)

pdb_image = plot_pdb(ref, res)
Image(pdb_image)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_discrete_03_direct_info_from_msa_21_0.png" src="../../_images/notebooks_discrete_03_direct_info_from_msa_21_0.png" />
</div>
</div>
<p>To further assess the extent to which direct information is predictive
of protein contacts, we compute the receiver operating characteristic
(ROC) curve that results from varying the number of predicted contacts.
The ROC curve is the true positive rate, i.e.&nbsp;the number of correctly
predicted contacts divided by the total number of contacts, versus the
false positive rate, i.e.&nbsp;the number of incorrectly predicted contacts
divided by the total number of noncontacting residue pairs. A perfect
binary classifier has an area under the ROC curve equal to 1.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [20]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>def roc(x, c):
    mask = np.triu(np.ones(di.shape[0], dtype=bool), k=2)
    order = x[mask].argsort()[::-1]
    c_flat = c[mask][order]
    tp = np.cumsum(c_flat, dtype=float)
    fp = np.cumsum(~c_flat, dtype=float)
    tp /= tp[-1]
    fp /= fp[-1]
    return fp, tp

fig, ax = plt.subplots(1, 1, figsize=(8, 8))
for i in range(refs.shape[0]):
    ref = refs.iloc[i]
    seq = msa[:, ref.seq]
    missing_aa_seq = seq == &#39;-&#39;
    di_idx = np.arange((~conserved_residues).sum())
    di_idx = di_idx[~missing_aa_seq[~conserved_residues]]
    di = direct_info[np.ix_(di_idx, di_idx)]
    contacts = contact_map(ref)
    fp, tp = roc(di, contacts)
    auc = tp.sum() / tp.shape[0]
    ax.plot(fp, tp, label=&#39;%s%s, %i-%i, AUC: %.02f&#39; % (ref.pdb_id, ref.chain, ref.pdb_start, ref.pdb_end, auc))

grid = np.linspace(0, 1)
ax.plot(grid, grid, &#39;r--&#39;, lw=1)
ax.set_xlabel(&#39;false positive rate&#39;)
ax.set_ylabel(&#39;true positive rate&#39;)
plt.legend()
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4oo8.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4cmq.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4oo8.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4zt0.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5f9r.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4un4.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4zt0.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5fw2.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5b2t.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4un5.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4cmp.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4cmq.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5fw3.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb5fq5.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4cmp.ent&#39;
Structure exists: &#39;../../../data/msa/Pfam-A.full/PF16592/pdb4zt9.ent&#39;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_discrete_03_direct_info_from_msa_23_1.png" src="../../_images/notebooks_discrete_03_direct_info_from_msa_23_1.png" />
</div>
</div>
</div>


          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2018, Joe McKenna.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.7.9.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>